"""
This module defines constructs for the optimizer.
See optimize.py
"""

import random
from typing import Any, Literal

import dspy
import pandas as pd
from gnagent.agent import GNAgent
from gnagent.config import *
from gnagent.prompts import *

EXAMPLE_PATH = "examples/examples.csv"


def get_dataset(split_ratio: int = 0.7, example_path: str = EXAMPLE_PATH) -> Any:
    data = pd.read_csv(example_path)
    data_dict = data_dicts = data[["query", "answer", "reasoning"]].to_dict(
        orient="records"
    )
    formatted = [
        dspy.Example(
            {"query": x["query"], "answer": x["answer"], "reasoning": x["reasoning"]}
        ).with_inputs("query")
        for x in data_dicts
    ]
    random.Random(2025).shuffle(formatted)
    train_set = formatted[: int(split_ratio * len(formatted_data))]
    eval_set = formatted[int(split_ratio * len(formatted_data)) :]

    # Always use 50-50 for validation and test sets
    val_set = eval_set[: int(0.5 * len(eval_set))]
    test_set = eval_set[int(0.5 * len(eval_set)) :]

    return train_set, val_set, test_set


class Judge(dspy.Signature):
    generated: str = dspy.InputField(desc="answer generated by the AI")
    correct: str = dspy.InputField(desc="correct answer from the dataset")
    decision: Literal["match", "no match"] = dspy.OutputField(desc="matching decision")
    confidence: float = dspy.OutputField(
        desc="percentage expressing confidence in decision"
    )


judge = dspy.Predict(Judge)


def match_checker(example: dspy.Example, prediction: dspy.Prediction) -> int:
    true_answer = example["answer"]
    judgement = judge(generated=prediction, correct=true_answer)
    decision, confidence = judgement.get("decision"), judgement.get("confidence")
    if confidence >= 0.6 and decision == Literal["match"]:
        return 1
    else:
        return 0


def match_checker_feedback(
    example: dspy.Example, prediction: dspy.Prediction
) -> dspy.Prediction:
    correct_answer = example["answer"]
    correct_reasoning = example["reasoning"]
    judgement = judge(generated=prediction, correct=correct_answer)
    decision, confidence = judgement.get("decision"), judgement.get("confidence")
    if confidence >= 0.6 and decision == Literal["match"]:
        outcome = 1
    else:
        outcome = 0

    feedback = ""
    if outcome == 1:
        feedback += (
            f"Your answer is acceptable. The correct answer is '{correct_answer}'."
        )
    else:
        feedback += f"Sorry, your answer is not acceptable. The correct answer is '{correct_answer}'."

    if correct_reasoning:
        feedback += f" Here's the full step-by-step reasoning:\n{correct_reasoning}\n\nThink about what takeaways you can learn from this solution to improve your future answers and approach to similar queries."

    return dspy.Prediction(outcome=outcome, feedback=feedback)



agent = GNAgent(
    corpus_path=CORPUS_PATH,
    pcorpus_path=PCORPUS_PATH,
    db_path=DB_PATH,
    naturalize_prompt=naturalize_prompt,
    rephrase_prompt=rephrase_prompt,
    analyze_prompt=analyze_prompt,
    check_prompt=check_prompt,
    summarize_prompt=summarize_prompt,
    synthesize_prompt=synthesize_prompt,
    split_prompt=split_prompt,
    finalize_prompt=finalize_prompt,
    sup_system_prompt1=sup_system_prompt1,
    sup_system_prompt2=sup_system_prompt2,
    plan_system_prompt=plan_system_prompt,
    refl_system_prompt=refl_system_prompt,
)


class QASignature(dspy.Signature):
    """
    Wraps query and answer for GNAgent
    """

    query: str = dspy.InputField(desc="user query")
    answer: str = dspy.OutputField(desc="final answer")


class GNAgentProgram(dspy.Module):
    """
    Transforms GNAgent to a dspy Program
    """

    def __init__(self, gn_agent: GNAgent):
        super().__init__()
        self.gn_agent = gn_agent
        self.predict = dspy.Predict(QASignature)

    def forward(self, query: str) -> dspy.Prediction:
        """
        Runs the async handler inside a temporary event loop.
        """
        # Run async graph
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        raw = loop.run_until_complete(self.gn_agent.handler(query))
        loop.close()

        answer = str(raw).strip()

        # Return a DSPy prediction
        return self.predict(query=query, answer=answer)


program = GNAgentProgram(agent)
